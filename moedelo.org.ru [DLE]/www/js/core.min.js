/*
 Semen Kamenetskiy <skamenetskiy@live.com>
 @copyright OOO "Moe Delo"
 @link http://www.moedelo.org/
*/
$(function(){function g(a){try{console.log("Buro: "+a)}catch(b){}}window.App||(window.App={Models:{},Views:{},Host:"www.moedelo.org",Controller:null});window.dataLayer=window.dataLayer||[];var m=/^([a-z0-9\.\-_\+]+)@([a-z0-9\.\-_]+)\.([a-z0-9\.\-_]+)$/i,n=/^[0-9]{10}$/i,l=App.Host;App.Models.AppModel=new (Backbone.Model.extend({defaults:{loaded:!1},initialize:function(){var a=this;$(window).on("load",function(){a.onLoad.call(a)})},onLoad:function(){if(!0===this.get("loaded"))return this;this.set("loaded",
!0);g("app:load");Backbone.history.start({history:!1});App.Views.ScrollView.scrollSpy=!0;App.Views.ScrollView.onScroll();var a=location.hash;"/"==location.pathname&&App.Controller.navigate(a,{trigger:!0});a=$(a.replace("/",""));0<a.size()&&App.Views.ScrollView.scrollTo(a.position().top-90);return this}}));App.Controller=new (Backbone.Router.extend({routes:{"":"defaultRoute",":page/*":"pageRoute"},initialize:function(){g("controller:init")},defaultRoute:function(){g("controller:route:defaultRoute");
App.Models.AppModel.trigger("route","home")},pageRoute:function(a){g("controller:route:"+a);App.Models.AppModel.trigger("route",a)}}));App.Views.ScrollView=new (Backbone.View.extend({el:document,$fixedRow1:$("#fixedMenuRow1"),$fixedRow2:$("#fixedMenuRow2"),$headerH1:$("#headerH1"),$headerFigure:$("#headerFigure"),scrollSpy:!1,scrollSpyAllElements:$(".js-header-menu"),scrollSpyElements:null,scrollSpyLastId:null,viewPortDimensions:{width:0,height:0},events:{scroll:"onScroll"},initialize:function(){var a=
this;this.listenTo(this.model,"route",this.onRouteChange);$(window).on("resize",function(){a.setViewPortDimensions.call(a)});this.setViewPortDimensions();this.onScroll()},setViewPortDimensions:function(){this.viewPortDimensions={width:Math.max(document.documentElement.clientWidth,window.innerWidth||0),height:Math.max(document.documentElement.clientHeight,window.innerHeight||0)}},onScroll:function(){var a=this.$el.scrollTop();0<a?(this.$fixedRow1.addClass("fixed"),0<=a&&100>=a&&this.$headerH1.css("opacity",
(100-a)/100),100<a&&(this.$headerH1.css("opacity",0),200>a&&this.$headerFigure.css("opacity",(200-a)/100),200<a&&this.$headerFigure.css("opacity",0),428<a?this.$fixedRow2.addClass("fixed"):this.$fixedRow2.removeClass("fixed"),this.scrollSpy&&this.checkScrollSpy(a))):(this.$fixedRow1.removeClass("fixed"),this.$fixedRow2.removeClass("fixed"),this.$headerH1.css("opacity",1),this.$headerFigure.css("opacity",1))},checkScrollSpy:function(a){var b=this;null===this.scrollSpyElements&&(b.scrollSpyElements=
[],$("body>section").each(function(){var a=$(this);b.scrollSpyElements.push({id:this.id,top:a.position().top,height:a.height(),$el:$(".js-"+this.id)})}));a+=this.viewPortDimensions.height/2;for(var d=0;d<this.scrollSpyElements.length;d++){var c=this.scrollSpyElements[d];if(a>c.top&&a<c.top+c.height){this.scrollSpyLastId!==c.id&&(this.scrollSpyAllElements.removeClass("active"),c.$el.addClass("active"),App.Controller.navigate("#/"+("governmentRevision"==c.id?"revision":c.id),{trigger:!1,replace:!0}),
this.scrollSpyLastId=c.id);break}}},scrollTo:function(a){$("html,body").animate({scrollTop:a+"px"});return this},onRouteChange:function(a){return"home"===a?this.scrollTo(0):this}}))({model:App.Models.AppModel});App.Views.LinksView=new (Backbone.View.extend({el:"body",events:{"click .js-link":"onClickLink","click .js-section-link":"onClickSection","click .js-clear-input":"onClickClearInput"},initialize:function(){},_extractHash:function(a){return a.substring(a.indexOf("#"))},onClickLink:function(a){g("navigate");
var b=this._extractHash($(a.currentTarget||a.target).prop("href"));"/"==location.pathname&&(a.preventDefault(),App.Controller.navigate(b,{trigger:!0}));a=$(b.replace("/",""));0<a.size()&&App.Views.ScrollView.scrollTo(a.position().top-90)},onClickSection:function(a){},onClickClearInput:function(a){$(a.currentTarget||a.target).parent().find('input[type="search"]').val("").focus()}}));App.Views.Calculators=new (Backbone.View.extend({el:"#calculators",events:{"click li":"onSelect"},initialize:function(){},
onSelect:function(a){a.preventDefault();this.$el.find("li>a").removeClass("active");$(a.currentTarget||a.target).find("a").addClass("active")}}));App.Views.Registration=new (Backbone.View.extend({el:"#registration",events:{"submit form":"onSubmit","focus form input":"onFocus",'keydown form input[name="phone"]':"onTelKeyDown"},initialize:function(){this.$el.find('input[name="name"]').focus()},hideErrors:function(){this.$el.find("form").find("div.error").hide();this.$el.find("form").find("input.error").removeClass("error")},
showError:function(a,b){this.hideErrors();a.addClass("error").parent().find(".error").html(b||"\u042d\u0442\u043e \u043f\u043e\u043b\u0435 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u043b\u044f \u0437\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f").show()},onSubmit:function(a){a.preventDefault();a=this.$el.find("form").serializeArray();var b={},d=this.$el.find("button"),c=this,e=!1,g={name:"Fio",email:"Email",password:"Password",phone:"Phone",Tariff:"Tariff",
RegistrationType:"RegistrationType"};this.hideErrors();_.each(a,function(a){if(!e){var d=a.name,f=a.value;a=$(c.$el.find('form input[name="'+a.name+'"]'));b[g[d]]=f;if(0===$.trim(f).length)return c.showError(a,"\u042d\u0442\u043e \u043f\u043e\u043b\u0435 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u043b\u044f \u0437\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f"),e=!0;if("email"==d&&!m.test(f))return c.showError(a,"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u044b\u0439 e-mail"),
e=!0;if("password"==d&&6>f.length)return c.showError(a,"\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u0434\u043b\u0438\u043d\u043d\u0435\u0435 6 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432"),e=!0;if("phone"==d&&!n.test(f))return c.showError(a,"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043b\u0435\u0444\u043e\u043d \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 +71234567890"),e=!0}});if(!e){d.attr("disabled","disabled");var h=
$("#progressBar"),k=10;h.show();this.interval=setInterval(function(){k++;h.width(k+"%")},500);$.ajax({url:"/api_reg.php",type:"post",dataType:"json",data:b,success:function(a){a.status?(dataLayer.push({event:"regBuro"}),a.url&&a.key&&(location.href="https://"+a.url+"/Default/AuthAfterRegistration?registrationKey="+a.key)):alert(a.message||"\u041f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430, \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0435 \u0440\u0430\u0437");
clearInterval(c.interval);d.removeAttr("disabled");h.width("0%").hide()},error:function(){clearInterval(c.interval);d.removeAttr("disabled");h.width("0%").hide()}})}},onFocus:function(a){this.hideErrors()},onTelKeyDown:function(a){var b=a.keyCode||a.which;return-1!==$.inArray(b,[46,8,9,27,13,110,190])||65==b&&!0===a.ctrlKey||35<=b&&39>=b?!0:(a.shiftKey||48>b||57<b)&&(96>b||105<b)?(a.preventDefault&&a.preventDefault(),a.returnValue=!1,a.originalEvent.returnValue=!1):!0}}));App.Views.Authorization=
new (Backbone.View.extend({el:"#authorization",events:{"submit form":"onSubmit"},initialize:function(){},hideErrors:function(){this.$el.find("form").find("div.error").hide();this.$el.find("form").find("input.error").removeClass("error")},showError:function(a,b){this.hideErrors();a.addClass("error").parent().find(".error").html(b||"\u042d\u0442\u043e \u043f\u043e\u043b\u0435 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u043b\u044f \u0437\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f").show()},
onSubmit:function(a){a.preventDefault();a=this.$el.find("form").serializeArray();var b={},d=this.$el.find("button"),c=this,e=!1,g={email:"email",password:"password"};this.hideErrors();_.each(a,function(a){if(!e){var d=a.name,f=a.value;a=$(c.$el.find('form input[name="'+a.name+'"]'));f=$.trim(f);b[g[d]]=f;if(0===$.trim(f).length)return c.showError(a,"\u042d\u0442\u043e \u043f\u043e\u043b\u0435 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u043b\u044f \u0437\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f"),
e=!0;if("password"==d&&4>f.length)return c.showError(a,"\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u0434\u043b\u0438\u043d\u043d\u0435\u0435 6 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432"),e=!0}});if(!e){d.attr("disabled","disabled");var h=$("#progressBar"),k=10;h.show();this.interval=setInterval(function(){k++;h.width(k+"%")},500);$.ajax({url:"/ajax/User/Authorize",type:"post",dataType:"json",data:b,crossDomain:!0,success:function(a){a.status?
location.href="https://"+l+"/redirect":alert(a.error||"\u041f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430, \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0435 \u0440\u0430\u0437");clearInterval(c.interval);d.removeAttr("disabled");h.width("0%").hide()},error:function(){location.href="https://"+l+"/Default/Auth"}})}},onFocus:function(a){this.hideErrors()}}))});
