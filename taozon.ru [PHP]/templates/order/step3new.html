<script type="text/javascript" src="js/order_delivery.js?<?=CFG_SITE_VERSION;?>"></script>

<?=Lang::loadJSTranslation(array('empty_delivery_country', 'empty_deliveries'));?>

<div class="spacer mb20"><div class="wrap clrfix"></div></div>

<div class="bigtitle">
    <div class="wrap clrfix">
        <h1><?=Lang::get('delivery')?></h1>
    </div>
</div>

<div class="main"><div class="wrap clrfix">
    <div class="bproduct" id="address_form">
        <span class="red"><?=Lang::get('stars_inputs')?></span>
        <br/>
        <br/>
        <div class="field">
            <div class="form-row">
                <? if (count($profiles)) { ?>
                    <label for="Profile"><?=Lang::get('Profiles')?></label>
                    <select name="profiles_select" id="profiles_select_step3" class="form-field form-field__select">
                        <? $profiles_count = 0; ?>
                        <? foreach ($profiles as $profile) { ?>
                            <? $profiles_count++; ?>
                            <option value="<?=$profile['id']?>"><?=Lang::get('Profile') . ' '  . $profiles_count ?></option>
                        <? } ?>
                    </select>
                <? } ?>
            </div>
        </div>
        <form action="index.php?p=userorder&step4&type=<?=$type?>" method="post" id="address_form2">
            <div class="profile-data" id="profile" >
                <? if (count($profiles)) { ?>
                    <input  id="ProfileId" type="hidden" name="Profile[Id]" value="" />
                <? } else { ?>
                    <input  id="ProfileCreate" type="hidden" name="Profile[New]" value="1" />
                <? } ?>

                <input type="hidden" name="type" value="<?=$type?>" />

                <fieldset >
                    <div class="field dib" id="RecipientLastName-parent">
                        <label for="LastName"><?=Lang::get('last_name')?><span class="red">*</span>:</label>
                        <input id="LastName" type="text" name="Profile[LastName]" value="" class="form-field" />
                    </div>
                    <div class="field dib" id="RecipientFirstName-parent">
                        <label for="FirstName"><?=Lang::get('name')?><span class="red">*</span>:</label>
                        <input id="FirstName" type="text" name="Profile[FirstName]" value="" class="form-field" />
                    </div>
                    <? if (! General::getConfigValue('hide_middle_name')) { ?>
	                    <div class="field dib" id="RecipientMiddleName-parent">
	                        <label for="middleName"><?=Lang::get('middle_name')?><span class="red">*</span>:</label>
	                        <input id="MiddleName" type="text" name="Profile[MiddleName]" value="" class="form-field" />
	                    </div>
                    <? } ?>

                </fieldset>

                <fieldset >
                    <? if (in_array('PassportData', General::$enabledFeatures)) { ?>
                        <div class="field dib" id="RecipientFirstName-parent">
                            <label for="PassportNumber"><?=Lang::get('passport')?></label>
                            <input id="PassportNumber" type="text" name="Profile[PassportNumber]" value="" class="form-field" />
                        </div>
                        <div class="field dib" id="RecipientFirstName-parent">
                            <label for="RegistrationAddress"><?=Lang::get('registrationaddress')?></label>
                            <input id="RegistrationAddress" type="text" name="Profile[RegistrationAddress]" value="" class="form-field" />
                        </div>
                    <? } ?>
                    <div class="field dib" id="Country-parent">
                        <label for="country"><?=Lang::get('country')?><span class="red">*</span>:</label>
                        <select name="Profile[CountryCode]" id="Country" class="form-field form-field__select" style="width: 258px;">
                                <? if (! count($profiles)) { ?>
                                    <option code="" value=""> <?=Lang::get('Not_selected')?></option>
                                <? } ?>
                                <? foreach($countries as $item) { ?>
                                <option code="<?=$item['Id']?>" value="<?=$item['Id']?>"> <?=$item['Name']?></option>
                                <? } ?>
                        </select>
                    </div>
                    <div class="field dib" id="PostalCode-parent">
                        <label for="PostalCode"><?=Lang::get('post_code')?>
                        <? if (General::getConfigValue('is_postal_code_required')) { ?>
                            <span class="red">*</span>
                        <? } ?>
                        </label>
                        <input id="PostalCode" type="text" name="Profile[PostalCode]" value="" class="form-field" />
                    </div>
                    <div class="field dib" id="Region-parent">
                        <label for="Region"><?=Lang::get('region')?>:</label>
                        <input id="Region" type="text" name="Profile[Region]" value="" class="form-field" />
                    </div>
                    <div class="field dib" id="City-parent">
                        <label for="City"><?=Lang::get('city')?><span class="red">*</span>:</label>
                        <input id="City" type="text" name="Profile[City]" value="" class="form-field" />
                    </div>
                    <div class="field dib" id="Address-parent">
                        <label for="Address"><?=Lang::get('address_full')?><span class="red">*</span>:</label>
                        <input id="Address" type="text" name="Profile[Address]" value="" class="form-field" />
                    </div>
                    <div class="field dib" id="Phone-parent">
                        <label for="Phone"><?=Lang::get('phone')?><span class="red">*</span>:</label>
                        <input id="Phone" type="text" name="Profile[Phone]" value="" class="form-field" />
                    </div>
                </fieldset>
            </div>


            <? if (General::getConfigValue('hide_step_delivery_order')) { ?>
                <div style="display: none">
            <? } ?>
            <h3 class="mt15"><?=Lang::get('delivery_method')?></h3>
            <strong><?=Lang::get('total_weight')?>:</strong> <?=$weight;?> <?=Lang::get('kg')?>
            <table class="notepad mt10 mb10" id="deliveries-list">
                <tr>
                    <td width="5%"></td>
                    <td width="60%"><?=Lang::get('delivery_options')?></td>
                    <td><?=Lang::get('delivery_cost')?></td>
                </tr>
                <? $i=0; if(is_array($models)) foreach ($models as $model){?>
                    <? $checked = ($i==0) ? 'checked="checked"' : ''; ?>
                    <? $i++;?>
                    <tr>
                        <? $model['description'] = preg_replace("/\[([^\]]+)\]/", "<a href='$1'>$1</a>", $model['description']); ?>
                        <? $model['description'] = str_replace("\n", "<br>", $model['description']); ?>
                        <td width="5%"><input type="radio" name="model" value="<?=$model['id'];?>" <?=$checked;?> /></td>
                        <td><strong><?=$model['name'];?></strong><br/><?=$model['description'];?></td>
                        <td><b><?=number_format((float)$model['price'], (int)General::$siteConf['price_round_decimals'], ",", " ")?> <?=(string)$model['currencysign']?></b></td>
                    </tr>
                <? } ?>
            </table>
            <? if (General::getConfigValue('hide_step_delivery_order')) { ?>
                </div>
            <? } ?>
            <? if(isset($_GET['weight']) && $_GET['weight']==0) { ?>
                <font color="#ff0000"><br/><?=Lang::get('desc_weight_0')?></font>
            <? } ?>
            <input type="hidden" name="total_weight" value="<?=$weight;?>"/>
            <input type="hidden" name="order" value="<?=$order;?>"/>

            <? if(Session::checkErrors()){ ?>
                <div class="bgr mb15 office_info_main order-msg  error" id="error_message" style="margin-bottom: 20px;">
                    <?=Lang::get(Session::getErrorDescription())?>
                </div>
            <? } ?>
            <div id="adr_spinner" style="display:none"><img src="css/i/ajax-loader.gif"></div>
            <h3 id="empty_deliveries" style="margin-bottom: 20px; display:<?=(empty($models) ? 'block' : 'none')?>">
                <div class="bgr mb15 office_info_main order-msg error">
                <?=Lang::get('empty_delivery_country')?>
                </div>
            </h3>

            <div class="b-pager">
                <? $params .= (isset($_GET['weight'])) ? '&weight='.$_GET['weight'] : '';?>
                <a href="index.php?p=userorder&step2<?=$params?>" class="btn btn-apper b-first-page"><?=Lang::get('back')?></a>
                <input class="btn btn-apper b-last-page" type="button" value="<?=Lang::get('make_order')?>" onclick="DisableSubmit('nextstep','address_form2');" id="nextstep">
            </div>
        </form>

    </div>
    
</div></div>
<!-- /.main -->
<!--noindex-->
<script type="text/javascript">
    var profiles = <?= json_encode($profiles) ?>;



    function checkinputstep3()
    {
        var f = true;

        if ($('#LastName').val() == '' && $('#LastName:visible').length) f = false;
        if ($('#FirstName').val() == '' && $('#FirstName:visible').length) f = false;
        if ($('#City').val() == '' && $('#City:visible').length) f = false;
        if ($('#Address').val() == '' && $('#Address:visible').length) f = false;
        if ($('#Phone').val() == '' && $('#Phone:visible').length) f = false;
        if ($('#deliveries-list tbody').html() == '') f = false
        if ($('#Country').val() == '' && $('#Country:visible').length) f = false;
        $('input[name=selected_profile_id]').val($('#profiles_select').val());

        if (!f) $('#nextstep').hide();
        if (f) $('#nextstep').show();
<? if (defined('CFG_DISCOUNTER_REORDER') && isset($_SESSION['DISCOUNTER_REORDER'])) { ?>

        $('#address_form').css('visible', 'hidden');
            $('#address_form').css('display', 'none');
            $('#adr_spinner').show();
            $('#address_form2').submit();
<? } ?>
    }
    checkinputstep3();
    $(function()
    {
        init_delivery_profile ();

        $('#LastName, #FirstName, #middleName, #PostalCode, #City, #Address, #Phone').keyup(function () {
            checkinputstep3();
        });
        $('#LastName, #FirstName, #middleName, #PostalCode, #City, #Address, #Phone').change(function () {
            checkinputstep3();
        });
        setInterval(checkinputstep3, 300);

        $('input#PassportNumber').on('keyup', function() {
            limitText(this, 255);
        });
    });
</script>
<!--/noindex-->

<?=Plugins::invokeEvent('onRenderOrderStep3')?>