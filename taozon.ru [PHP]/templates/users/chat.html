<? if($chat !== false){ ?>
<?if ( Session::checkErrors()) {?>
        <h3 style="color:#F00"><?=Session::getErrorDescription()?></h3>
<?}?>
<h1><?=empty($chat['TicketInfo']['OrderId'])?$chat['TicketInfo']['TicketId']:Lang::get('order_number_is').' '.(defined('CFG_PREFIX_REPLACE_ORD')?str_replace('ORD', CFG_PREFIX_REPLACE_ORD, $chat['TicketInfo']['OrderId']):(string)$chat['TicketInfo']['OrderId'])?> (<?=$this->escape($chat['TicketInfo']['Subject'])?>)</h1>
<? if(isset($error)){ ?>
    <div class="error"><?=$error?></div>
    <? } ?>
<div id="support">
    <div class="bproduct">
        <h2 class="mb20"><span><?=Lang::get('messages_list')?></span></h2>
        <? if(is_array($chat['TicketMessageList'])){ ?>
        <? foreach($chat['TicketMessageList'] as $msg){ ?>
            <div class="message">
                <div class="title">
                    <div class="date flr"><?=$msg['CreatedDate']?></div>
                    <div class="name">
                        <?
                        if ($msg['Direction']!='Out') {
                            print $name ? $this->escape($name) : $this->escape($user['login']);
                        } else {
                            print Lang::get('operator');
                        }
                        ?>
                    </div>
                </div>
                <div class="content">
                    <?=$this->parseTextWithUrl(nl2br($this->escape($msg['Text'])))?>
                </div>
            </div>
            <? } ?>
        <? } ?>
    </div>
    <? if ($chat['TicketInfo']['Status']!='close') { ?>
    <div class="bproduct mb30">
        <h2 class="mb15"><span><?=Lang::get('new_message2')?></span></h2>
        <div class="userform newmessage">
            <form action="<?=$_SERVER['REQUEST_URI']?>" method="post" id="chatform" onsubmit="return ChechSupportChat()">
                <div class="form-row">
                    <label for="Text"><?=Lang::get('message_text')?>:</label>
                    <span class="input"><textarea id="Text" name="Text" onkeypress="AnableSubmit('chat_button','chatform')" class="form-field form-field__textarea"><?=$this->escape($_POST['Text'])?></textarea></span>
                </div>

                <div class="form-row send">
                    <input type="button" name="send" value="<?=Lang::get('send_message')?>" class="btn_office"  id="chat_button" onclick="DisableSubmit('chat_button','chatform');"/>
                </div>
                <? if ($isAdmin) { ?>
                <div class="form-row send">
                    <input type="button" value="<?=Lang::get('close')?>" class="btn_office" onclick="javascript:document.location.href='index.php?p=support&mode=close&id=<?=$chat['TicketInfo']['TicketId']?>&userid=<?=$_GET['userid']?>'"/>
                </div>
                <? } ?>
            </form>
        </div>
    </div>
    <? } else { ?>
        <?=Lang::get('ticket_closed')?>
    <? } ?>
</div>
<? }else{ ?>
<b><?=$error?></b>
<? } ?>

