<div class="main"><div class="canvas clrfix">
    <h2>Оформление заказа: расчет веса заказа</h2><br/><br/>
    <form method="post" action="index.php?p=userorder&step2">
        <? if(count($list)) {?>
        <table class="notepad">
            <thead>
                <tr>
                    <td class="td1" width="5%">Товар</td>
                    <td width="40%">Оригинал</td>
                    <td width="12%">Конфигурация</td>
                    <td class="td4" width="10%">Вес единицы товара(в кг.)</td>
                    <td align="center" width="10%">Количество</td>
                    <td width="15%">Вес общий</td>
                </tr>
            </thead>

            <tbody>
                <? $total_w = 0; ?>
                <? $sign = ''; ?>
                <? foreach($list as $item){ ?>
                <? $total_w += $item['Quantity']*$item['Weight'];?>
                <? $sign = ' кг.'; ?>
                <tr id="item<?=$item['ItemId']?>">
                        <td class="td1">
                                <ul class="i40 flin"><li><a href="index.php?p=item&id=<?=$item['ItemId'];?>"><img src="<?=$item['PictureURL'];?>_40x40.jpg" alt="" width="100%" height="100%"/></a></li></ul>
                        </td>
                        <td width="350px">
                                <a href="index.php?p=item&id=<?=$item['ItemId'];?>"><?=$item['ItemTitle'];?> </a><br/>
                                <b>Оригинал:&nbsp;</b><a target="blank" href="<?=$item['ExternalURL'];?>"><?=$item['ItemId'];?></a><br/>
                                <b>Продавец:&nbsp;</b><a href="index.php?p=vendor&id=<?=$item['VendorId'];?>"><?=$item['VendorId'];?></a><br/>

                        </td>
                        <td width="100px">
                            <ul class="flin coptions">
                                    <? if (isset($item['ItemConfiguration'])) { ?>
                                    <li><?=$item['ItemConfiguration'];?></li>
                                    <? } ?>
                            </ul>
                        </td> 
                        <td class="td4" width="130px" style="text-align: center;" >
                            <input type="text" size="5" name="w<?$item['ItemId']?>" id="w<?=$item['ItemId']?>" value="<?=$item['Weight']?>" onchange="change_wight(<?=$item['ItemId']?>)"/>
                        </td> 

                        <td style="text-align: center;" >
                            <div id="num<?=$item['ItemId']?>"><?=$item['Quantity']?></div>
                            <input type="hidden" name="price<?$item['ItemId']?>" id="price<?=$item['ItemId']?>" value="<?=$item['Price']?>"/>
                            <input type="hidden" name="cur<?$item['ItemId']?>" id="cur<?=$item['ItemId']?>" value="<?=$item['CurrencySign']?>"/>
                            <input type="hidden" id="elemid<?=$item['ItemId'];?>" value="<?=$item['Id'];?>"/>
                        </td>
                        <td>
                            <span id="sum_w<?=$item['ItemId']?>">&nbsp;&nbsp;<? echo round($item['Quantity']*$item['Weight'],2).' '.$sign; ?></span>
                        </td>
                    </tr>
                    <?  }  ?>
                    <tr>
                        <td colspan="5"></td>
                        <td>
                            <strong>Итого:&nbsp;</strong><span id="total_w"><? echo ' '.round($total_w, 2).' '.$sign;?></span>
                        </td>
                    </tr>  
                </tbody>
        </table>
        <br/><br/>

        <div class="clrfix mt20">
            <div style="float:left;cursor:pointer;background:none;background-color:#F15A24">
                <a href="index.php?p=basket" class="b30 fll"><span style="background:none">Назад</span></a>
            </div>
            <div>
                <input class="b30 fll" style="float:right;cursor:pointer;background:none;background-color:#F15A24" type="submit" name="nextstep" value="Продолжить"/>
            </div>
        </div>
        <? }  else {?>
            <h3> Товары не найдены! </h3>
        <? } ?>
    <input type="hidden" id="total_weight"  name="total_weight" value="<?=$total_w;?>"/>
    </form>		
</div></div>

<!--noindex-->
<script type="text/javascript">
    
var count = <?=count($list)?>;
var itemlist = new Array();
<? $i=1; if (!empty($list)) foreach($list as $item) { ?>
    itemlist[<?=$i?>] = new Array();
    <?foreach($item as $key=>$value) { ?>
        itemlist[<?=$i?>]['<?=$key?>'] = '<?=$value?>';
    <?}?>
<? $i++;} ?>

//изменение веса товара

function change_wight( id ){
    var num    = $('#num' + id).html();
    var weight = $('#w' + id).val();
    var elemid = $('#elemid' + id).val();
    var cur    = ' кг.';

    sum = num*weight;
    $('#sum_w' + id).html(sum.toFixed(2)  + ' ' + cur);
    
    var total_w = 0; 

    for(var i=1; i<=count; i++){
        item_id  = itemlist[i]['ItemId'];
        item_num = $('#num' + item_id).html();
        item_w   = $('#w' + item_id).val();
        var sum_w = item_num*item_w;
        total_w += sum_w;
    }
    
    $('#total_w').html(total_w.toFixed(2)  + ' ' + cur);
    $('#total_weight').val(total_w.toFixed(2));
    
    $.ajax({
        url: 'index.php?p=editorderweight&id=' + elemid + '&w=' + weight,
        success: function(data) {
        }
    });
}

$(function(){
    for(var i=1; i<=count; i++){
        id  = itemlist[i]['ItemId'];
        $('#w' + id).numberMask({type:'float',afterPoint:2,defaultValueInput:'',decimalMark:'.'});
    }
})
</script>
<!--/noindex-->