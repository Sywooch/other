(function(){var each=tinymce.each,extend=tinymce.extend,JSON=tinymce.util.JSON;var Node=tinymce.html.Node,scriptRegExp;function ucfirst(s){return s.charAt(0).toUpperCase()+s.substring(1)};var mediaTypes={"Flash":{classid:"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",type:"application/x-shockwave-flash",codebase:"http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"},"ShockWave":{classid:"clsid:166b1bca-3f9c-11cf-8075-444553540000",type:"application/x-director",codebase:"http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"},"WindowsMedia":{classid:"clsid:6bf52a52-394a-11d3-b153-00c04f79faa6",type:"application/x-mplayer2",codebase:"http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"},"QuickTime":{classid:"clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b",type:"video/quicktime",codebase:"http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"},"DivX":{classid:"clsid:67dabfbf-d0ab-41fa-9c46-cc0f21721616",type:"video/divx",codebase:"http://go.divx.com/plugin/DivXBrowserPlugin.cab"},"RealMedia":{classid:"clsid:cfcdaa03-8be4-11cf-b84b-0020afbbccfa",type:"audio/x-pn-realaudio-plugin"},"Java":{classid:"clsid:8ad9c840-044e-11d1-b3e9-00805f499d93",type:"application/x-java-applet",codebase:"http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"},"Silverlight":{classid:"clsid:dfeaf541-f3e1-4c24-acac-99c30715084a",type:"application/x-silverlight-2"},"Video":{type:'video/mp4'},"Audio":{type:'audio/mp3'}};tinymce.create('tinymce.plugins.MediaPlugin',{init:function(ed,url){var self=this,lookup={};this.mimes={};scriptRegExp='';(function(data){var items=data.split(/,/),i,y,ext;for(i=0;i<items.length;i+=2){ext=items[i+1].split(/ /);for(y=0;y<ext.length;y++){self.mimes[ext[y]]=items[i]}}})("application/x-director,dcr"+"video/divx,divx"+"application/pdf,pdf,"+"application/x-shockwave-flash,swf swfl,"+"audio/mpeg,mpga mpega mp2 mp3,"+"audio/ogg,ogg spx oga,"+"audio/x-wav,wav,"+"video/mpeg,mpeg mpg mpe,"+"video/mp4,mp4 m4v,"+"video/ogg,ogg ogv,"+"video/webm,webm,"+"video/quicktime,qt mov,"+"video/x-flv,flv,"+"video/vnd.rn-realvideo,rv"+"video/3gpp,3gp"+"video/x-matroska,mkv");self.editor=ed;self.url=url;each(mediaTypes,function(v,k){v.name=k;if(v.classid){lookup[v.classid]=v}if(v.type){lookup[v.type]=v}lookup['mceItem'+k]=v;lookup[k.toLowerCase()]=v;scriptRegExp+=(scriptRegExp?'|':'')+k});scriptRegExp=new RegExp('(JCEMediaObject\\.|write)('+scriptRegExp+')\\(([^)]+)\\)','i');self.lookup=lookup;function isMediaElm(n){return/mceItem(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|Silverlight|Audio|Video|Generic)/.test(n.className)};ed.onPreInit.add(function(){ed.schema.addValidElements('object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]');ed.parser.addNodeFilter('object,embed,video,audio,script',function(nodes){var i=nodes.length;while(i--)self.toImage(nodes[i])});ed.serializer.addNodeFilter('img',function(nodes,name,args){var i=nodes.length,node;while(i--){node=nodes[i];if(/mceItem(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|Silverlight|Audio|Video|Generic)/.test(node.attr('class')||'')){self.restoreElement(node,args)}}})});ed.onInit.add(function(){if(ed.theme&&ed.theme.onResolveName){ed.theme.onResolveName.add(function(theme,o){if(o.name==='img'&&/mceItem(Object|Embed|Audio|Video|Generic)/.test(o.node.className)){o.name='media'}})}if(ed.settings.content_css!==false)ed.dom.loadCSS(url+"/css/content.css")});ed.onNodeChange.add(function(ed,cm,n){cm.setActive('media',n.nodeName=='IMG'&&isMediaElm(n))})},getInfo:function(){return{longname:'Media',author:'Moxiecode Systems AB / Ryan Demmer',authorurl:'http://tinymce.moxiecode.com',infourl:'http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media',version:'1.5.7.11'}},toImage:function(n){var self=this,ed=this.editor,type,name,node,o={},data={},classid='',matches;if(!n.parent||/^(object|audio|video|embed)$/.test(n.parent.name))return;var img=new Node('img',1);if(n.name==='script'){if(n.firstChild)matches=scriptRegExp.exec(n.firstChild.value);if(!matches||!matches.length)return;type=this.lookup[matches[2].toLowerCase()].name;data=JSON.parse(matches[3]);w=data.width;h=data.height;name='object'}else{name=n.name;var style=ed.dom.parseStyle(n.attr('style'));var w=n.attr('width')||style.width;var h=n.attr('height')||style.height;each(['bgcolor','align','border','vspace','hspace'],function(na){var v=n.attr(na);if(v){switch(na){case'bgcolor':style.backgroundColor=v;break;case'align':if(/^(left|right)$/.test(v)){style['float']=v}else{style['vertical-align']=v}break;case'vspace':style['margin-top']=style['margin-bottom']=v;break;case'hspace':style['margin-left']=style['margin-right']=v;break}}});var type=n.attr('type'),src=n.attr('src')||n.attr('data');if(name=='embed'&&type=='application/x-shockwave-flash'){name='object';each(['bgcolor','flashvars','wmode','allowfullscreen','allowscriptaccess','quality'],function(k){var v=n.attr(k);if(v){if(k=='flashvars'){v=encodeURIComponent(v)}data[k]=v}})}if(name=='object'){node=n;if(n.attr('classid')){classid=n.attr('classid').toLowerCase()}var lookup=this.lookup[classid]||this.lookup[n.attr('type')]||this.lookup[name]||this.lookup['flash'];type=lookup.name||'';each(['title','archive','codetype','declare','standby','type','usemap'],function(na){var v=n.attr(na);if(v){data[na]=v}});if(!type){each(['type','classid','codebase','src'],function(na){var v=n.attr(na);if(v){data[na]=v}})}each(n.getAll('param'),function(p){var k=p.attr('name'),v=p.attr('value');if(v){if(k=='flashvars'){v=encodeURIComponent(v)}data[k]=v}});data.src=src||data.src||data.movie||data.source;if(data.movie){delete data.movie}if(data.source){delete data.source}}if(name=='audio'||name=='embed'||name=='video'){node=n;if(name=='embed'){each(['bgcolor','flashvars','wmode','allowfullscreen','allowscriptaccess','quality','type'],function(na){var v=n.attr(na);if(v){data[na]=v}})}else{var children=n.getAll('object');fallback=tinymce.grep(children,function(o){return o.attr('type')=='application/x-shockwave-flash'});if(fallback.length){var s=[],fb={},el=fallback[0];each(['data'],function(na){var v=el.attr(na);if(v){fb[na]=v}});each(el.getAll('param'),function(p){var k=p.attr('name'),v=p.attr('value');if(k&&v!=''){if(k=='flashvars'){v=encodeURIComponent(v)}fb[k]=v}});s.push(fb);data['fallback']=fb}if(sources=n.getAll('source')){var s=[];each(sources,function(el){var at={};each(['type','src','media'],function(na){var v=el.attr(na);if(v){at[na]=v}});s.push(at)});if(s.length){data['source']=s;delete data.src}}}each(['title','autoplay','controls','loop','preload','src','contenteditable','contextmenu','draggable','hidden','item','itemprop','spellcheck','subject'],function(na){var v=n.attr(na);if(na=='autoplay'||na=='controls'||na=='loop'){data[na]=v?na:''}else{if(v==''||v==null||v=='undefined'){return}else{data[na]=v}}})}each(['audio','embed','object','video','param','source'],function(el){each(n.getAll(el),function(node){node.remove()})});var html=new tinymce.html.Serializer({inner:true,validate:false}).serialize(node);if(html){data['html']=tinymce.DOM.encode(html)}each(['id','lang','dir','tabindex','xml:lang','style'],function(at){img.attr(at,n.attr(at))});var styles=ed.dom.serializeStyle(style);if(styles){img.attr('style',styles)}}data=JSON.serialize(data);data=data.replace(/^\{([\s\S]+?)\}$/,'$1').replace(/"/g,"'");img.attr({src:this.url+'/img/trans.gif',width:w||300,height:h||300,'class':'mceItem'+ucfirst(name)+(type?' mceItem'+ucfirst(type):''),'title':data});n.replace(img)},restoreElement:function(n){var self=this,ed=this.editor,replacement,name='object',so=false,o={};var data=n.attr('title');if(!/^\{([\s\S]+?)\}$/.test(data)){data='{'+data+'}'}data=JSON.parse(data);var src=data.src;var type=data.type||this.getMimeType(n.attr('class'))||this.getMimeType(src);var style=ed.dom.parseStyle(n.attr('style'));if(ed.getParam('media_use_script')){node=new Node('script',1).attr('type','text/javascript');extend(data,{width:n.attr('width')||style.width||100,height:n.attr('height')||style.height||100});value=new Node('#text',3);value.value='JCEMediaObject.'+(this.lookup[type].name).toLowerCase()+'('+JSON.serialize(data)+');';node.append(value);n.replace(node);return}var html=data.html||'';delete data.type;delete data.html;delete data.width;delete data.height;var args=['id','lang','dir','tabindex','xml:lang','style'];if(src){src=ed.convertURL(src,'src')}var name=this.getNodeName(n.attr('class'));replacement=new Node(name,1).attr({width:n.attr('width')||style.width||100,height:n.attr('height')||style.height||100});switch(name){case'object':if(type=='application/x-silverlight-2'){o.data='data:application/x-silverlight-2,';data.source=src;delete data.src;so=true}if(type=='application/x-shockwave-flash'){if(ed.getParam('media_strict')){o.data=src;so=true}else{data.movie=src;delete data.src}}if(type=='application/x-mplayer2'){data.url=data.src;delete data.src}if(!so){var props=this.lookup[type];extend(o,{classid:props.classid,codebase:props.codebase})}each(['archive','declare','data','standby','usemap'],function(na){replacement.attr(na,data[na]);delete(data[na])});each(data,function(v,k){if(tinymce.inArray(args,k)==-1){if(k=='flashvars'){v=decodeURIComponent(v)}var param=new Node('param',1).attr({'name':k,'value':v.toString()});param.shortEnded=true;replacement.append(param)}});delete data.url;delete data.movie;if(!so){embed=new Node('embed',1).attr({src:src,type:type,width:n.attr('width'),height:n.attr('height')});each(data,function(v,k){if(k=='flashvars'){v=decodeURIComponent(v)}embed.attr(k,v.toString())});replacement.append(embed)}break;case'embed':case'audio':case'video':function addSource(props){src=ed.convertURL(props.src,'src');type=props.type||self.getMimeType(src)||'';var source=new Node('source',1).attr({type:type,src:src});source.shortEnded=true;replacement.append(source)}if(data.source&&typeof data.source=='object'&&data.source instanceof Array){each(data.source,function(k){addSource(k)});delete data.src;delete data.type;delete data.source}else{if(name=='audio'||name=='video'){addSource({src:src,type:type})}else{data.type=type;args.push('src');args.push('type')}}args=args.concat(args,['autoplay','controls','loop','preload','contenteditable','contextmenu','draggable','hidden','item','itemprop','spellcheck','subject']);each(args,function(na){v=data[na];if(na=='autoplay'||na=='controls'||na=='loop'){v=v?na:''}v=typeof v=='boolean'?v.toString():v;if(v!=''){replacement.attr(na,v)}});if(data.object){var fb=data.object;var fbElm=new Node('object',1).attr({data:fb.data,width:n.width,height:n.height,type:'application/x-shockwave-flash'});if(fb.param){each(fb.param,function(v,k){var param=new Node('param',1);param.shortEnded=true;param.attr({'name':k,'value':v});fbElm.append(param)})}replacement.append(fbElm)}break}each(args,function(na){replacement.attr(na,n.attr(na))});replacement.attr(o);if(html){var htmlNode=new Node('#text',3);htmlNode.raw=true;htmlNode.value=tinymce.DOM.decode(html);replacement.append(htmlNode)}if(replacement){n.replace(replacement)}else{n.remove()}},getMimeType:function(s){var props,type,ext;if(s){cl=s.match(/mceItem(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|PDF|Silverlight)/)}if(cl){props=mediaTypes[cl[1]];if(props){type=props.type}}if(!props||type){if(/\.([a-z0-9]{2,4})/.test(s)){ext=s.substring(s.length,s.lastIndexOf('.')+1).toLowerCase();type=this.mimes[ext]}}return type},getNodeName:function(s){s=/mceItem(Audio|Embed|Object|Video)/.exec(s);if(s){return s[1].toLowerCase()}return'object'}});tinymce.PluginManager.add('media',tinymce.plugins.MediaPlugin)})();