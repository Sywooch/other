<?php if (!defined('DIAFAN')){include(dirname(dirname(dirname(__FILE__))).'/includes/404.php');} class Update_admin extends Frame_admin { public function show() { if ($this->IIIIIIIIIIl1()) return; switch($this->diafan->page) { case 2: $this->IIIIIIIIIIlI(); break; case 3: $this->IIIIIIIIIIll(); break; default: $this->IIIIIIIIIII1(); break; } } private function IIIIIIIIIII1() { echo '<a href="'.$this->diafan->get_admin_url('page').'page2/">'.$this->diafan->_('Проверить обновления').'</a>'; }private function IIIIIIIIIIlI() {$IIIIIIIIIIlI=$this->get_result(); global $IIIIIIIIII111; $this->IIIIIIIIII11('',$IIIIIIIIII111); if ($IIIIIIIIIIlI) { echo '<p>'.$this->diafan->_('Доступны следующие обновления').':</p> <form action="'.$this->diafan->get_admin_url().'save1/" method="POST"><input type="hidden" name="check_hash_user" value="'.$this->diafan->_user->get_hash().'">'; if (is_array($IIIIIIIIIIlI)) foreach ($IIIIIIIIIIlI as $IIIIIIIIIIll) {$IIllIIIlIIll = DB::query_result("SELECT COUNT(*) FROM {update} WHERE name='%h'", $IIIIIIIIIIll["path"]);echo '<p><input type="checkbox"'.(! $IIllIIIlIIll ? ' checked' : '').' name="upd'.$IIIIIIIIIIll["file_id"].'"> <b>'.$IIIIIIIIIIll["path"].'</b><br>';if ($IIllIIIlIIll){echo '<font color="red">'.$this->diafan->_('Внимание! Вы изменили файл. Его обновление приведет к потере внесенных изменений.').'</font><br>';}echo $IIIIIIIIIIll["description"].'</p>'; } echo '<input type="submit" value="'.$this->diafan->_('Обновить').'" class="button" onmouseover="this.style.cursor=\'hand\';">'; echo ' </form>'; }else{echo '<font color="red">'.$this->diafan->_('Система обновлена!').'</font>'; $this->diafan->_cache->delete("","update");}} private function IIIIIIIIIIll() { echo '<p><font color="red">'.$this->diafan->_('Система обновлена!').'</font></p>';if (! empty($_GET["repair"])){echo '<p><a href="'.BASE_PATH_HREF.'update/repair/?repair=1">'.$this->diafan->_('Требуется обновление базы данных.').'</a></p>';} }private function IIIIIIIIIIl1() {$IIII=false;if (file_exists(ABSOLUTE_PATH.'config.php') &&  ! is_writable(ABSOLUTE_PATH.'config.php')){echo '<p>'.$this->diafan->_('Установите права на запись (777) для файла конфигурации config.php').'</p>';$IIII=true;} if (!extension_loaded('ftp')){echo '<p>'.$this->diafan->_('Не установлено PHP-расширение для работы с FTP').'</p>';$IIII=true;}if (!FTP_HOST || !FTP_LOGIN || ! FTP_PASSWORD){echo '<p>'.$this->diafan->_('Укажите параметры подключения к FTP-серверу вашего сайта.').'<br><a href="'.BASE_PATH_HREF.'config/">'.$this->diafan->_('Параметры сайта').'</a></p>'; $IIII=true; } return $IIII; }private function get_result($result) { global $result, $IIIIIIIIII111; $IIIIIIIIII1I=$result; $IIIIIIIIII1I[0] = unserialize($IIIIIIIIII1I[0]);$this->diafan->_cache->save((empty($IIIIIIIIII1I[0]) ? 'empty' : $IIIIIIIIII1I[0]),"result","update", true); $IIIIIIIIII111 = $IIIIIIIIII1I[1]; return $IIIIIIIIII1I[0]; }public function save() {if (! $this->diafan->_user->checked){$this->diafan->redirect(URL);return false;}require_once ABSOLUTE_PATH.'plugins/ftp.php';$IIIIIIIIIIlI=$this->diafan->_cache->get("result", "update", true);if (!$IIIIIIIIIIlI) {$IIIIIIIIIIlI=$this->get_result();}if(! $IIIIIIIIIIlI || $IIIIIIIIIIlI === 'empty'){$this->diafan->redirect($this->diafan->get_admin_url('page').'page3/'); } $IIIIIIIIII1l = new Ftp;$IIIIIIIIII11=DATE_UPDATE;try{ $host = FTP_HOST; if(strpos($host, ':') !== false){list($host,$port) = explode(':', FTP_HOST, 2);}$IIIIIIIIII1l->connect($host,empty($port) ? NULL : (int) $port);$IIIIIIIIII1l->login(FTP_LOGIN, FTP_PASSWORD);$IIIIIIIIII1l->pasv(true); $IIIIIIIIII1l->chdir(FTP_DIR);if (is_array($IIIIIIIIIIlI)) foreach ($IIIIIIIIIIlI as $IIIIIIIIIIll) {  if (!empty($_POST["upd".$IIIIIIIIIIll["file_id"]])) {$IIIIIIIIII1l->put($IIIIIIIIIIll["path"], 'http://user.diafan.ru/file/'.$IIIIIIIIIIll["file_id"].'/'.$IIIIIIIIIIll["code"].'/', FTP_BINARY);if ($IIIIIIIIII11<$IIIIIIIIIIll["created"]) { $IIIIIIIIII11=$IIIIIIIIIIll["created"];}if (! empty($IIIIIIIIIIll["update_db"])){$db = true;} } }}catch (FtpException $IIIIIIIIIlIl) { $mes=$IIIIIIIIIlIl->getMessage(); switch($mes) { case "Login incorrect.": $mes=$this->diafan->_('Невозможно подклчится к FTP-серверу. Указаны неправильные параметры подключения.'); break; case FTP_DIR.": No such file or directory": $mes=$this->diafan->_('Указанной директории не существует'); break;case 'failed to open stream: HTTP request failed! HTTP/1.1 404 Not Found':$mes=$this->diafan->_('Файл для обновления недоступен');break;}echo '<script language="javascript" type="text/javascript">alert(\''.strip_tags($mes).'\');document.location="'.BASE_PATH_HREF.'config/";</script>'; exit; }$IIIIIIIIII1l->close();global $IIIIIIIIII111;$this->IIIIIIIIII11($IIIIIIIIII11, $IIIIIIIIII111); $this->diafan->_cache->delete("","update"); $this->diafan->redirect($this->diafan->get_admin_url('page').'page3/'.(! empty($db)? '?repair=1' : '')); } private function IIIIIIIIII11($IIIIIIIIII11 = '',$IIIIIIIIII111 = '') {if (! $IIIIIIIIII11) {$IIIIIIIIII11=DATE_UPDATE; }if (! $IIIIIIIIII111) {$IIIIIIIIII111 = DIAFAN_CODE; }Customization::inc('includes/config.php'); $II1I1I1III11 = array('DATE_UPDATE' => $IIIIIIIIII11, 'DIAFAN_CODE' => $IIIIIIIIII111);Config::save($II1I1I1III11, $this->diafan->languages);} }
