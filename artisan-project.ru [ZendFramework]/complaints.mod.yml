tables:
  complaints:
    on_create: {compldate: 'Y-m-d H:i:s'}
    fields:
      id: {type: int, length: 10, auto_increment: 1, notnull: 1, am: {type: integer, title: ID}}
      company: {type: text, notnull: 0, am: {type: string, title: Компания, req: 0}}
      city: {type: text, notnull: 1, am: {type: string, title: Город, req: 1}}
      user_name: {type: text, notnull: 1, am: {type: string, title: Ваше имя, req: 1}} 
      phone: {type: text, notnull: 1, am: {type: string, title: Ваш телефон, req: 1}}
      mail: {type: tinytext, notnull: 1, am: {type: mail, title: Ваш адрес электронной почты, req: 1}}
      reason_id: {type: int, notnull: 1, default: 0, am: {type: select, null: Не выбрана, title: Причина обращения, req: 1}}
      title: {type: text, notnull: 1, am: {type: string, title: Заголовок, req: 1}}
      dealer_id: {type: int, notnull: 1, default: 0, am: {type: select, null: Не выбран, title: 'Клиент (дилер)', req: 1}}
      compldate: {type: datetime, notnull: 0, am: {type: datetime, default: '', title: Дата поступления претензии}}
      last_req_date: {type: datetime, notnull: 0, am: {type: datetime, default: '', title: Дата поступления последнего сообщения дилера по претензии}}
      last_answ_date: {type: datetime, notnull: 0, am: {type: datetime, default: '', title: Дата последнего ответа}}
      status: {type: enum('new','not_answered','answered','closed'), default: 'new', notnull: 1, am: {type: radio, title: Статус ответа, otitle: Статус, default: 'new', req: 1, values: {new: '<font color="red">непрочтённая</font>', not_answered: '<font color="blue">прочтённая, но не отвеченная</font>', answered: '<font color="green">отвеченная</font>', closed: '<font color="black">завершённая</font>'}}}
      status_view: {type: enum('readed','not_readed'), default: 'not_readed', notnull: 1, am: {type: radio, title: Статус просмотра, otitle: Статус, default: 'not_readed', req: 1, values: {readed: 'просмотренная', not_readed: 'не просмотренная'}}}
      public_date_from: {am: {type: date, default: '', title: от}}
      public_date_to: {am: {type: date, default: '', title: до}}
      answerer_id: {type: int, notnull: 0, default: 0, am: {type: select, null: Не выбран, title: 'Ответивший', req: 0}}
    foreign:
      reason: {table: reasons, field: title, use_ref: complaints2reasons, am: reason_id}
      dealer: {table: dealers, field: title, use_ref: complaints2dealers, am: dealer_id}
      answerer: {table: users, field: name, use_ref: complaints2users, am: answerer_id}
      text: {table: communication, field: text, use_ref: complaints2communication, am: {type: raw_text, title: 'Текст', req: 1, attrs: {style: 'width: 500px; height: 100px;'}}}
      #file:
      #  table: communication
      #  field: file
      #  use_ref: complaints2communication
      #  am:
      #    type: file
      #    req: 0
      #    title: Файл
      #    del_by_id: true
      #    allowed_ext: [pdf, txt, jpg, jpeg, gif, png, doc, docx, xls, xlsx]
      files:
        virtual: 1
        ref_to:
          virtual: 1
          table: files
          fields: [id, file]
          insert_fields: [pid]
          use_ref: files2communication
        am:
          type: files
          title: Файлы
          req: 0
          del_by_id: true
          allowed_ext: [pdf, txt, jpg, jpeg, gif, png, doc, docx, xls, xlsx]
    table:
      PRIMARY KEY: id
      KEYS:
        dealer_id: [dealer_id]
    actions:
      list: [id, compldate, dealer_id, reason_id, title, last_req_date, last_answ_date, status, answerer]
      add: [company, city, user_name, phone, mail, dealer_id, reason_id, title, last_req_date, last_answ_date, status]
      modify: [company, city, user_name, phone, mail, compldate, dealer_id, reason_id, title, last_req_date, last_answ_date, status]
      show: [company, city, user_name, phone, mail, compldate, dealer_id, reason_id, title, last_req_date, last_answ_date, status]
      cms_mail: [company, city, user_name, phone, mail, reason, title]
      cms_filter: [public_date_from, public_date_to]
      site_form: [company, city, user_name, phone, mail, reason_id, title, text, files]
      site_archive: [id, reason, title, status, status_view, last_answ_date]
    paging:
      npp: 200
      css_class: 'paging'
      base_url: ''
      url_append: ''
      separator: ' '
      linkcount: 10
      first: ''
      prev: ''
      next: ''
      last: ''
      skip: ' ... '

  reasons:
    fields:
      id: {type: int, length: 10, auto_increment: 1, notnull: 1, am: {type: integer}}
      title: {type: tinytext, notnull: 1, am: {type: string, title: Название причины обращения, req: 1}}
      active: {type: enum('yes','no'), default: 'yes', notnull: 1, am: {type: string, title: Отображать на сайте, htmltype: checkbox, default: 'yes', checked: 'yes', unchecked: 'no', values: {no: нет, yes: да}}}
    table:
      PRIMARY KEY: id
      KEYS:
        active: [active]
    actions:
      list: [id, title, active]
      add: [title, active]
      modify: [title, active]
      show: [id, title, active]

#таблица ответов
  communication:
    on_create: {commdate: 'Y-m-d H:i:s'}
    fields:
      id: {type: int, length: 10, auto_increment: 1, notnull: 1, am: {type: integer}}
      complaint_id: {type: int, notnull: 1, default: 0, am: {type: integer, title: ID претензии, req: 1}}
      commdate: {type: datetime, notnull: 0, am: {type: datetime, default: '', title: Дата поступления сообщения}}
      text: {type: text,  notnull: 1, am: {type: raw_text, title: 'Текст', req: 1, attrs: {style: 'width: 500px; height: 100px;'}}}
      #file:
      #  type: text
      #  notnull: 0
      #  default: 0
      #  am:
      #    type: file
      #    req: 0
      #    title: Файл
      #    del_by_id: true
      #    allowed_ext: [pdf, txt, jpg, jpeg, gif, png, doc, docx, xls, xlsx] 
      is_answer: {type: enum('yes','no'), default: 'yes', notnull: 1, am: {type: string, title: Ответ администратора, htmltype: checkbox, default: 'yes', checked: 'yes', unchecked: 'no', values: {no: нет, yes: да}} 
      files:
        virtual: 1
        ref_to:
          virtual: 1
          table: files
          fields: [id, file]
          insert_fields: [pid]
          use_ref: files2communication
        am:
          type: files
          title: Файлы
          req: 0
          del_by_id: true
          allowed_ext: [pdf, txt, jpg, jpeg, gif, png, doc, docx, xls, xlsx]    
    table:
      PRIMARY KEY: id
      KEYS:
        complaint_id: [complaint_id]
        is_answer: [is_answer]
    actions:
      list: [id, complaint_id, commdate, text, files, is_answer]
      add: [complaint_id, commdate, text, files, is_answer]
      modify: [complaint_id, commdate, text, files, is_answer]
      show: [id, complaint_id, commdate, text, files, is_answer]
      cms_form: [text, files]
      site_form: [text, files]

  dealers:
    dont_install: 1
    fields:
      id: {type: int, notnull: 1, unsigned: 1, auto_increment: 1}
      cdate: {type: datetime, am: {type: datetime, title: Дата создания дилера}}
      mdate: {type: datetime, am: {type: datetime, title: Дата редактирования дилера}}
      ch_pass_date: {type: datetime, am: {type: datetime, title: Дата смены пароля дилером}}
      login: {type: varchar, length: 32, notnull: 1, am: {type: login, req: 1, title: Логин}}
      pass: {type: varchar, length: 32, notnull: 1, am: {type: pass, req: 1, htmltype: pass, title: Пароль}}
      blocked: {type: "enum('yes','no')", default: 'no', notnull: 1, am: {type: string, title: Доступ к системе, otitle: Запретить, htmltype: checkbox, default: 'no', checked: 'yes', values: {no: доступ разрешен, yes: доступ запрещен}}}
      deleted: {type: "enum('yes','no')", default: 'no', notnull: 1, am: {type: string, title: Удалить, otitle: Удалить, htmltype: checkbox, default: 'no', checked: 'yes', values: {no: доступ разрешен, yes: Удален}}}
      title: {type: tinytext, notnull: 1, am: {type: string, title: Наименование}}
      city: {type: text, notnull: 1, am: {type: string, title: Город}}
      description: {type: tinytext, notnull: 0, am: {type: text, title: Описание}}
      mail: {type: tinytext, notnull: 1, am: {type: mail, title: Электронная почта}}
      category_id: {type: int, notnull: 1, unsigned: 1, am: {type: select, title: Категория дилера}}
      supplier_id: {type: int, notnull: 1, unsigned: 1, am: {type: select, title: Поставщик}}
      price_id: {foreign: 1, table: dealers_categories, field: price_id, use_ref: dealers2categories, am: 'dealers_categories->price_id'}

      have_discount: {foreign: 1, ref_to: {use_ref: dealers2categories, field: have_discount, table: dealers_categories}, am: 'dealers_categories->have_discount'}
      show_remains: {foreign: 1, ref_to: {use_ref: dealers2categories, field: show_remains, table: dealers_categories}, am: 'dealers_categories->show_remains'}
      legal_entities:
        virtual: 1
        ref_to:
          idFieldName: id
          virtual: 1
          table: ?_dealers_legal_entities
          fields: [id, phone, legal_entity, legal_address, actual_address, inn, current_account, bank, correspondent_account, bik]
          use_ref: dealers2legal_entities
        am: {title: Юридические лица}
        
  files:
    fields:
      id: {type: int, length: 10, unsigned: 1, auto_increment: 1, notnull: 1, am: {type: integer}}
      pid: {type: int, length: 10, notnull: 1}
      model: {type: text, notnull: 0, am: {type: string, title: Модель}}
      file:
        type: tinytext
        notnull: 0
        am:
          type: file
          req: 0
          title: Файл
    table:
      PRIMARY KEY: id 
        
refs:
  complaints2reasons: {type: M-1, join: left, tables: {complaints: reason_id, reasons: id}}
  complaints2communication: {type: M-1, join: left, tables: {communication: complaint_id, complaints: id}}
  complaints2dealers: {type: M-1, join: left, tables: {complaints: dealer_id, dealers: id}}
  complaints2users: {type: M-1, join: left, tables: {complaints: answerer_id, users: id}}
  files2communication:
    type: N-M
    join: LEFT
    tables:
      -
        - {table: communication, field: id}
        - {table: files, field: pid}

mail:
  complaint_answ:
    from: 'problema@artisan-project.ru'
    subject: 'Ответ на Вашу претензию [reason_title]'
    type: text/html
    message: |
      Здесь вы можете посмотреть <a href="[complaint_link]">ответ</a> на вашу претензию.

  complaint_compl:
    from: 'problema@artisan-project.ru'
    subject: 'Поступила новая претензия [reason_title]'
    type: text/html
    message: |
      Поступила новая претензия: [reason_title].<br>
      От дилера: [company], [city], [user_name] [phone] [mail].<br>
      Текст претензии: [text]<br>
      Чтобы ответить на запрос перейдите  <a href="[complaint_link]">сюда</a>.

  complaint_comm:
    from: 'problema@artisan-project.ru'
    subject: 'Поступило новое сообщение по претензии [reason_title]'
    type: text/html
    message: |
      Поступило новое сообщение по претензии: [reason_title].<br>
      Текст претензии: [text]<br>
      Чтобы ответить на запрос перейдите  <a href="[complaint_link]">сюда</a>.

  repl:
    site_name: "Public Post"
  date_format: H:i:s d.m.Y


