<?$upblock_info=$_REQUEST['upblock_info'];$addProperty=$_REQUEST['addProperty'];$upblock_tip_is=$_REQUEST['upblock_tip_is'];$upblock_block_is=$_REQUEST['upblock_block_is'];$upblock_tip_in=$_REQUEST['upblock_tip_in'];$upblock_block_in=$_REQUEST['upblock_block_in'];if(!empty($_REQUEST['NewBlock1'])) {	$NewBlock=$_REQUEST['NewBlock1'];} else {	$NewBlock=1;}function GetSKUProperty($ID,$SKUID) {	$arResult = false;	$ID = intval($ID);	$SKUID = intval($SKUID);	if ((0 < $ID) && (0 < $SKUID)) {		$rsProps = CIBlockProperty::GetList(array(),array('IBLOCK_ID' => $SKUID,'PROPERTY_TYPE' => 'E','LINK_IBLOCK_ID' => $ID,'ACTIVE' => 'Y'));		while ($arProp = $rsProps->Fetch()) {			if ((true == is_array($arProp)) && ('N' == $arProp['MULTIPLE'])) {				$arResult = $arProp;				break;			}		}	}	return $arResult;}/*echo '<pre>'; print_r($upblock_info); echo '</pre>';echo '<pre>'; print_r($addProperty); echo '</pre>';echo '<pre>'; print_r($NewBlock); echo '</pre>';echo '<pre>'; print_r($upblock_tip_is); echo '</pre>';echo '<pre>'; print_r($upblock_block_is); echo '</pre>';echo '<pre>'; print_r($upblock_tip_in); echo '</pre>';echo '<pre>'; print_r($upblock_block_in); echo '</pre>';die('123');*/CModule::IncludeModule("iblock");if ($NewBlock!=1) {	$dbGetBlock= CIBlock::GetByID($upblock_block_is);	if ($arrGetBlock = $dbGetBlock->Fetch()) {		//echo '<pre>'; print_r($arrGetBlock); echo '</pre>'; die();	    $ib = new CIBlock;					// sites		$SITES = '';		$rsSites = CIBlock::GetSite($upblock_block_is);		while($arSite = $rsSites->Fetch()) {			$SITES .= ($SITES!=""?" / ":"").htmlspecialchars($arSite["SITE_ID"]);		}				// udalyaem nenujnoe		unset($arrGetBlock['ID']);		unset($arrGetBlock['TIMESTAMP_X']);				// copiruem kartinku		if ($arrGetBlock['PICTURE']) {			$picture = CFile::MakeFileArray(CFile::CopyFile($arrGetBlock['PICTURE']));			$arrGetBlock['PICTURE'] = $picture;		}				$arFields=$arrGetBlock;		$arFields['NAME'] = $NewBlock;		$arFields['IBLOCK_TYPE_ID'] = $upblock_tip_in;		$arFields['SITE_ID'] = $SITES;				$IdNewBlock = $ib->Add($arFields);				// prava dostupa		CIBlock::SetPermission($IdNewBlock, CIBlock::GetGroupPermissions($upblock_block_is));				// polya elementov ibloka		CIBlock::SetFields($IdNewBlock, CIBlock::GetFields($upblock_block_is));				// dop polya iblocka		CIBlock::SetMessages($IdNewBlock, CIBlock::GetMessages($upblock_block_is));	}	//esli u iblocka est torg predlogeniya, to sozdaem kopiu iblocka torgovih predloggenii	$mxResult = CCatalogSKU::GetInfoByProductIBlock($upblock_block_is);	if ($mxResult['IBLOCK_ID']) {		$dbGetBlockTP= CIBlock::GetByID($mxResult['IBLOCK_ID']);		if ($arrGetBlockTP = $dbGetBlockTP->Fetch()) {		    $ibTP = new CIBlock;							unset($arrGetBlockTP['ID']);			unset($arrGetBlockTP['TIMESTAMP_X']);						// copiruem kartinku			if ($arrGetBlockTP['PICTURE']) {				$pictureTP = CFile::MakeFileArray(CFile::CopyFile($arrGetBlockTP['PICTURE']));				$arrGetBlockTP['PICTURE'] = $pictureTP;			}						$arFieldsTP=$arrGetBlockTP;			$arFieldsTP['NAME'] = $arrGetBlockTP["NAME"]." (".$NewBlock.")";			$arFieldsTP['IBLOCK_TYPE_ID'] = $arrGetBlockTP["IBLOCK_TYPE_ID"];			$IBLOCK_TYPE_IDTP = $arrGetBlockTP["IBLOCK_TYPE_ID"];			$arFieldsTP['SITE_ID'] = $SITES;						$IdNewBlockTP = $ibTP->Add($arFieldsTP);						// prava dostupa			CIBlock::SetPermission($IdNewBlockTP, CIBlock::GetGroupPermissions($mxResult['IBLOCK_ID']));						// polya elementov ibloka			CIBlock::SetFields($IdNewBlockTP, CIBlock::GetFields($mxResult['IBLOCK_ID']));						// dop polya iblocka			CIBlock::SetMessages($IdNewBlockTP, CIBlock::GetMessages($mxResult['IBLOCK_ID']));		}		$arFieldsTP= Array("IBLOCK_ID"=>$mxResult['IBLOCK_ID']);		$arrProperSootvTP=array();		if ($addProperty==1) {			$CountPropTP=0;			$CnalichTP=0;			$dbPropISTP=CIBlock::GetProperties($mxResult['IBLOCK_ID']);			while($arPropISTP=$dbPropISTP->Fetch()) {				if($arPropISTP['CODE']!="CML2_LINK") {									$nalichTP=array();								$ibpTP = new CIBlockProperty;					$arrNewProTP = $arPropISTP;					$arrNewProTP['IBLOCK_ID'] = $IdNewBlockTP;										// proveryaem est' li eto svo-vo uje v ibloke					$resTP = CIBlockProperty::GetByID($arPropISTP['CODE'], $IdNewBlockTP, FALSE);					if ($ar_resTP = $resTP->GetNext()) {						$ibpTP->Update($ar_resTP['ID'], $arrNewProTP);					} else {						$PropIDTP = $ibpTP->Add($arrNewProTP);						if ($PropIDTP!=false) { $CountPropTP++; }						$arrProperSootvTP[$arPropISTP['ID']]=$PropIDTP;					}										// varianti tipa SPISOK					if ($arrNewProTP['PROPERTY_TYPE']=='L') {						$property_enumsTP = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$mxResult['IBLOCK_ID'], "CODE"=>$arPropISTP['CODE']));						while ($enum_fieldsTP = $property_enumsTP->Fetch()) {							$enum_fieldsTP['PROPERTY_ID'] = $PropIDTP;							unset($enum_fieldsTP['EXTERNAL_ID']);							unset($enum_fieldsTP['XML_ID']);														$ibpenumTP = new CIBlockPropertyEnum;							$PropListIDTP = $ibpenumTP->Add($enum_fieldsTP);						}					}				}			}		}			$intIBlockID = $IdNewBlockTP;		$intIBlockID2 = $IdNewBlock;		$res = CIBlock::GetList(			Array(), 			Array('SITE_ID'=>SITE_ID, 'ACTIVE'=>'Y', 'CNT_ACTIVE'=>'Y', 'ID' => $intIBlockID), true		);		CCatalog::Add(array("IBLOCK_ID"=>$intIBlockID));				$arProp = GetSKUProperty($intIBlockID2,$intIBlockID);		$ibp = new CIBlockProperty();		if ((false === $arProp) || ((true == is_array($arProp)) && ('N' != $arProp['MULTIPLE']))) {			$arOFProperty = array(					'NAME' => "".GetMessage("IBLOCKCOPI_STEP_2_ELEM_CAT")."",					'IBLOCK_ID' => $intIBlockID,					'PROPERTY_TYPE' => 'E',					'USER_TYPE' =>'SKU',					'LINK_IBLOCK_ID' => $intIBlockID2,					'ACTIVE' => 'Y',					'SORT' => '5',					'MULTIPLE' => 'N',					'CODE' => 'CML2_LINK',					'XML_ID' => 'CML2_LINK',					"FILTRABLE" => "Y",					"SEARCHABLE" => "N",				);			$intSKUPropID = $ibp->Add($arOFProperty);		} elseif (('SKU' != $arProp['USER_TYPE']) || ('CML2_LINK' != $arProp['XML_ID'])) {			$arFields = array(				'USER_TYPE' => 'SKU',				'XML_ID' => 'CML2_LINK',			);			$boolFlag = $ibp->Update($arProp['ID'],$arFields);						if (false === $boolFlag) {				$arResult = array(					'RESULT' => 'ERROR',					'MESSAGE' => $ibp->LAST_ERROR,				);			} else {				$intSKUPropID = $arProp['ID'];			}		} else {			$intSKUPropID = $arProp['ID'];		}								$arOffersFields = array(			'IBLOCK_ID' => $intIBlockID,			'PRODUCT_IBLOCK_ID' => $intIBlockID2,			'SKU_PROPERTY_ID' => $intSKUPropID		);		$obCatalog = new CCatalog();		$arOFCatalog = CCatalog::GetByID($intIBlockID);		if ($arOFCatalog) {			$boolFlag = $obCatalog->Update($intIBlockID,$arOffersFields);		} else {			$boolFlag = $obCatalog->Add($arOffersFields);		}	}}if ($NewBlock != 1) {	$upblock_block_in=$IdNewBlock;}if (CModule::IncludeModule("catalog") && CCatalog::GetByID($upblock_block_is) && !CCatalog::GetByID($upblock_block_in)) {	$NewNalichTorgov=array();	$NewTorgCatalog = new CCatalog;	$arrNalichTorgov = CCatalog::GetByID($upblock_block_is);	$NewNalichTorgov = $arrNalichTorgov;	$NewNalichTorgov['IBLOCK_ID']=$upblock_block_in;	$NewTorgCatalog->Add($NewNalichTorgov);}$arFields= Array("IBLOCK_ID"=>$upblock_block_is);$arrProperSootv=array();if ($addProperty==1) {	$CountProp=0;	$Cnalich=0;	$dbPropIS=CIBlock::GetProperties($upblock_block_is);	while($arPropIS=$dbPropIS->Fetch()) {		$nalich=array();			$ibp = new CIBlockProperty;		$arrNewPro = $arPropIS;		$arrNewPro['IBLOCK_ID'] = $upblock_block_in;				// proveryaem est' li eto svo-vo uje v ibloke		$res = CIBlockProperty::GetByID($arPropIS['CODE'], $upblock_block_in, FALSE);		if ($ar_res = $res->GetNext()) {			$ibp->Update($ar_res['ID'], $arrNewPro);		} else {			$PropID = $ibp->Add($arrNewPro);			if ($PropID!=false) { $CountProp++; }			$arrProperSootv[$arPropIS['ID']]=$PropID;		}				// varianti tipa SPISOK		if ($arrNewPro['PROPERTY_TYPE']=='L') {			$property_enums = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$upblock_block_is, "CODE"=>$arPropIS['CODE']));			while ($enum_fields = $property_enums->Fetch()) {				$enum_fields['PROPERTY_ID'] = $PropID;				unset($enum_fields['EXTERNAL_ID']);				unset($enum_fields['XML_ID']);								$ibpenum = new CIBlockPropertyEnum;				$PropListID = $ibpenum->Add($enum_fields);			}		}	}}if($upblock_info==1) {	$arrNewId=array();	$arrNewSectionss=array();		// sozdaem kopii kategorii	$dbAllSection=CIBlockSection::GetTreeList($arFields);	while($arrAllSection=$dbAllSection->Fetch()) {		$bs = new CIBlockSection;		$id="";				$arrNewSectionss = $arrAllSection;		unset($arrNewSectionss['ID']);		$arrNewSectionss['IBLOCK_ID']=$upblock_block_in;								$arrNewSectionss['IBLOCK_TYPE_ID']=$upblock_tip_in;		if ($arrAllSection['PICTURE']) { $arrNewSectionss['PICTURE']=CFile::MakeFileArray(CFile::CopyFile($arrAllSection['PICTURE'])); }		if ($arrAllSection['DETAIL_PICTURE']) { $arrNewSectionss['DETAIL_PICTURE']=CFile::MakeFileArray(CFile::CopyFile($arrAllSection['DETAIL_PICTURE'])); }		if ($arrAllSection['IBLOCK_SECTION_ID']) { $arrNewSectionss['IBLOCK_SECTION_ID']=$arrNewId[$arrAllSection['IBLOCK_SECTION_ID']]; } else { $arrNewSectionss['IBLOCK_SECTION_ID']=FALSE; }				$id=$bs->Add($arrNewSectionss);		$arrNewId[$arrAllSection['ID']]=$id;	}	// sozdaem kopiu elementov	$countElem=0;	$arFilter = Array("IBLOCK_ID"=>$upblock_block_is);		$NewElementbI=array();	$dbElem = CIBlockElement::GetList(Array(), $arFilter);	while ($arrElem=$dbElem->GetNextElement()) {		$NewProperty=array();		$CElement = new CIBlockElement;			$ar_res = $arrElem->GetFields();		$props = $arrElem->GetProperties();						foreach ($ar_res as $key => $value) {			if (strpos($key, "~")!==FALSE) {				unset($ar_res[$key]);			}		}				foreach ($props as $Propvalue) {			//var_dump($Propvalue);			if ($Propvalue['VALUE'] && isset($arrProperSootv[$Propvalue['ID']])) { // esli svo-vo ne pustoe && u nas sozdalos' novoe				if ($Propvalue['PROPERTY_TYPE']=="F") {					if (is_array($Propvalue['VALUE'])) {						foreach ($Propvalue['VALUE'] as $key => $value) {							$NewProperty[$Propvalue['CODE']]['n'.$key]=array('VALUE'=>CFile::MakeFileArray(CFile::CopyFile($value)));							if ($Propvalue['DESCRIPTION'][$key]) {								$NewProperty[$Propvalue['CODE']]['n'.$key]['DESCRIPTION'] = $Propvalue['DESCRIPTION'][$key];							}						}					} else {						$NewProperty[$Propvalue['CODE']]['n0']=array('VALUE'=>CFile::MakeFileArray(CFile::CopyFile($Propvalue['VALUE'])));					}				} elseif ($Propvalue['PROPERTY_TYPE']=="L") {					$property_enums = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$upblock_block_in, "PROPERTY_ID"=>$arrProperSootv[$Propvalue['ID']]));					while($enum_fields = $property_enums->GetNext()) {						if (in_array($enum_fields['VALUE'], $Propvalue['VALUE'])) {							$NewProperty[$Propvalue['CODE']][]=array('VALUE'=>$enum_fields['ID']);						}					}				} else {					$NewProperty[$Propvalue['CODE']] = $Propvalue['VALUE'];				}			}		}		$NewElementbI = $ar_res;		$NewElementbI['IBLOCK_ID']= $upblock_block_in;		$NewElementbI['IBLOCK_TYPE_ID']= $upblock_tip_in;		$NewElementbI['IBLOCK_SECTION_ID'] = $arrNewId[$ar_res['IBLOCK_SECTION_ID']];				if ($ar_res['PREVIEW_PICTURE']) {			$NewElementbI['PREVIEW_PICTURE']=CFile::MakeFileArray(CFile::CopyFile($ar_res['PREVIEW_PICTURE']));		}		if ($ar_res['DETAIL_PICTURE']) {			$NewElementbI['DETAIL_PICTURE']=CFile::MakeFileArray(CFile::CopyFile($ar_res['DETAIL_PICTURE']));		}			if ($addProperty==1) {			$NewElementbI['PROPERTY_VALUES']= $NewProperty;		}		$ElemError=$CElement->Add($NewElementbI);		if ($ElemError==false) {			echo $CElement->LAST_ERROR;		}		if ($ElemError!=false) {			$countElem++;		}				//torgovie predlogeniya			$countElemTP=0;		$offersTP = CIBlockPriceTools::GetOffersArray($ar_res["IBLOCK_ID"], $ar_res["ID"], Array(), Array(), Array(), "",Array ());		foreach ($offersTP as $offersAr) {			if ($offersAr["ID"]) {				$countElemTP1=0;				$arFilterTP1 = Array("IBLOCK_ID"=>$offersAr["IBLOCK_ID"],"ID"=>$offersAr["ID"]);								$NewElementbITP1=array();							$dbElemTP1 = CIBlockElement::GetList(Array(), $arFilterTP1);				while ($arrElemTP1=$dbElemTP1->GetNextElement()) {						$NewPropertyTP1=array();						$CElementTP1 = new CIBlockElement;							$ar_resTP1 = $arrElemTP1->GetFields();						$propsTP1 = $arrElemTP1->GetProperties();								foreach ($ar_resTP1 as $keyTP1 => $valueTP1) {							if (strpos($keyTP1, "~")!==FALSE) {								unset($ar_resTP1[$keyTP1]);							}						}									foreach ($propsTP1 as $PropvalueTP1) {						if ($PropvalueTP1['VALUE'] && isset($arrProperSootvTP1[$PropvalueTP1['ID']])) { // esli svo-vo ne pustoe && u nas sozdalos' novoe							if ($PropvalueTP1['PROPERTY_TYPE']=="F") {								if (is_array($PropvalueTP1['VALUE'])) {									foreach ($PropvalueTP1['VALUE'] as $keyTP1 => $valueTP1) {										$NewPropertyTP1[$PropvalueTP1['CODE']]['n'.$keyTP1]=array('VALUE'=>CFile::MakeFileArray(CFile::CopyFile($valueTP1)));										if ($PropvalueTP1['DESCRIPTION'][$keyTP1]) {											$NewPropertyTP1[$PropvalueTP1['CODE']]['n'.$keyTP1]['DESCRIPTION'] = $PropvalueTP1['DESCRIPTION'][$keyTP1];										}									}								} else {									$NewPropertyTP1[$PropvalueTP1['CODE']]['n0']=array('VALUE'=>CFile::MakeFileArray(CFile::CopyFile($PropvalueTP1['VALUE'])));								}							} elseif ($PropvalueTP1['PROPERTY_TYPE']=="L") {								$property_enumsTP1 = CIBlockPropertyEnum::GetList(Array("DEF"=>"DESC", "SORT"=>"ASC"), Array("IBLOCK_ID"=>$offersAr["IBLOCK_ID"], "PROPERTY_ID"=>$arrProperSootvTP1[$PropvalueTP1['ID']]));								while($enum_fieldsTP1 = $property_enumsTP1->GetNext()) {									if (in_array($enum_fieldsTP1['VALUE'], $PropvalueTP1['VALUE'])) {										$NewPropertyTP1[$PropvalueTP1['CODE']][]=array('VALUE'=>$enum_fieldsTP1['ID']);									}								}							} else {								$NewPropertyTP1[$PropvalueTP1['CODE']] = $PropvalueTP1['VALUE'];							}						}					}								$NewElementbITP1 = $ar_resTP1;					$NewElementbITP1['IBLOCK_ID']= $IdNewBlockTP;					$NewElementbITP1['IBLOCK_TYPE_ID']= $IBLOCK_TYPE_IDTP;					$NewElementbITP1['IBLOCK_SECTION_ID'] = $arrNewIdTP1[$ar_resTP1['IBLOCK_SECTION_ID']];										if ($ar_resTP1['PREVIEW_PICTURE']) {						$NewElementbITP1['PREVIEW_PICTURE']=CFile::MakeFileArray(CFile::CopyFile($ar_resTP1['PREVIEW_PICTURE']));					}					if ($ar_resTP1['DETAIL_PICTURE']) {						$NewElementbITP1['DETAIL_PICTURE']=CFile::MakeFileArray(CFile::CopyFile($ar_resTP1['DETAIL_PICTURE']));					}									if ($addPropertyTP1==1) {						$NewElementbITP1['PROPERTY_VALUES']= $NewPropertyTP1;					}								$ElemErrorTP1=$CElementTP1->Add($NewElementbITP1);					if ($ElemErrorTP1==false) {						echo $CElementTP1->LAST_ERROR;					}					if ($ElemErrorTP1!=false) {						$countElemTP1++;					}					if (CModule::IncludeModule("catalog")) {  						$dbProductTP1 = CCatalogProduct::GetList(array(), array("ID"=>$ar_resTP1['ID']));						if ($arProductTP1 = $dbProductTP1->Fetch()) {								$arProductTP1['ID']=$ElemErrorTP1;							$arProductTP1['ELEMENT_IBLOCK_ID']=$IdNewBlockTP;											$err1TP1 = CCatalogProduct::Add($arProductTP1);											$dbPriceTP1 = CPrice::GetList(array(), array("PRODUCT_ID"=>$ar_resTP1['ID']));							while ($arPriceTP1 = $dbPriceTP1->Fetch()) {								$NewPriceTP1=array();								$NewPriceTP1['PRODUCT_ID']=$ElemErrorTP1;								$NewPriceTP1['CATALOG_GROUP_ID']=$arPriceTP1['CATALOG_GROUP_ID'];								$NewPriceTP1['PRICE']=$arPriceTP1['PRICE'];								$NewPriceTP1['CURRENCY']=$arPriceTP1['CURRENCY'];								$NewPriceTP1['QUANTITY_FROM']=$arPriceTP1['QUANTITY_FROM'];								$NewPriceTP1['QUANTITY_TO']=$arPriceTP1['QUANTITY_TO'];																$tTP1=CPrice::Add($NewPriceTP1);								// echo '<pre>'; print_r($NewPrice); echo '</pre>';							}											if ($tTP1==false) {														//echo $APPLICATION->GetException()->GetString();								//echo "<br/>";							}						}					}					CIBlockElement::SetPropertyValueCode($ElemErrorTP1,"CML2_LINK",$ElemError);									}			}		}  		if (CModule::IncludeModule("catalog")) {  			$dbProduct = CCatalogProduct::GetList(array(), array("ID"=>$ar_res['ID']));			if ($arProduct = $dbProduct->Fetch()) {					$arProduct['ID']=$ElemError;				$arProduct['ELEMENT_IBLOCK_ID']=$upblock_block_in;					$err1 = CCatalogProduct::Add($arProduct);					$dbPrice = CPrice::GetList(array(), array("PRODUCT_ID"=>$ar_res['ID']));				while ($arPrice = $dbPrice->Fetch()) {					$NewPrice=array();					$NewPrice['PRODUCT_ID']=$ElemError;					$NewPrice['CATALOG_GROUP_ID']=$arPrice['CATALOG_GROUP_ID'];					$NewPrice['PRICE']=$arPrice['PRICE'];					$NewPrice['CURRENCY']=$arPrice['CURRENCY'];					$NewPrice['QUANTITY_FROM']=$arPrice['QUANTITY_FROM'];					$NewPrice['QUANTITY_TO']=$arPrice['QUANTITY_TO'];										$t=CPrice::Add($NewPrice);					// echo '<pre>'; print_r($NewPrice); echo '</pre>';				}					if ($t==false) {											//echo $APPLICATION->GetException()->GetString();					//echo "<br/>";				}			}		}	}}echo '<h5>'; print_r(GetMessage("IBLOCKCOPI_COPI_ELEM_STEP_2")); echo '</h5>';echo '<pre>'; print_r(GetMessage("IBLOCKCOPI_STEP_2_CAPTION").$CountProp); echo '</pre>';echo '<pre>'; print_r(GetMessage("IBLOCKCOPI_STEP_2_ELEM").$countElem); echo '</pre>';?>